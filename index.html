<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>Writing Adapters for DataMapper</title>
   <meta name="author" content="Paul Sadauskas" />
   <meta name="company" content="Absolute Performance, Inc" />

   <!-- configuration parameters -->
   <meta name="defaultView" content="slideshow" />
   <meta name="controlVis" content="hidden" />

   <link rel="stylesheet" href="stylesheets/slides.css" type="text/css" media="projection" id="slideProj" />
   <link rel="stylesheet" href="stylesheets/outline.css" type="text/css" media="screen" id="outlineStyle" />

   <link rel="stylesheet" href="stylesheets/highlight.css" type="text/css" media="screen" />
   <!-- S5 JS -->
   <script src="javascripts/slides.js" type="text/javascript"></script>

   <script src="javascripts/highlight.pack.js" type="text/javascript"></script>
   <script type="text/javascript">
     hljs.initHighlightingOnLoad('ruby');
   </script>
</head>
<body>

<div class="layout">
  <div id="controls"><!-- DO NOT EDIT --></div>
  <div id="currentSlide"><!-- DO NOT EDIT --></div>
  <div id="header">MountainWest2009</div>
  <div id="footer">
    <h2>Copyright &copy; Paul Sadauskas - Creative Commons</h2>
  </div>
</div>

<div class="presentation">
  <div class="slide">
<h1 id='writing_datamapper_adapters'>Writing DataMapper Adapters</h1>

<p><a href='psadauskas@gmail.com'>Paul Sadauskas</a> a.k.a <a href='http://twitter.com/TheAmazingRando'>Rando</a></p>

<p><a href='http://absolute-performance.com'>Absolute Performance, Inc</a></p>

</div>

<div class="slide">
<h1 id='who_the_hell_are_you'>Who the Hell are You?</h1>

<p>I&#8217;m Paul Sadauskas. Find me on the intarwebs:</p>

<ul>
<li>irc: Rando@irc.freenode.net</li>

<li>xmpp: <a href='psadauskas@gmail.com'>psadauskas@gmail.com</a></li>

<li>www: <a href='http://theamazingrando.com/blog'>TheAmazingRando.com/blog</a></li>
</ul>

<p>DataMapper Hacker:</p>

<ul>
<li>Designed <code>AbstractAdapter</code> API</li>

<li>Wrote initial implementation of the reference adapter, <code>InMemoryAdapter</code></li>
</ul>

</div>

<div class="slide">
<h1 id='wtf_is_datamapper'>WTF is DataMapper?</h1>

<p>A lightweight, modular Ruby ORM.</p>

<ul>
<li>Lazy Loading</li>

<li>(Strategic) Eager Loading</li>

<li>Plugin Architecture</li>

<li>Non-Relational Database Adapters</li>
</ul>

</div>

<div class="slide">
<h1 id='lazyloading'>Lazy-Loading</h1>

<p>The query doesn&#8217;t hit the adapter until it has to.</p>

<pre><code>articles = Article.all
articles.all(:author =&gt; &quot;Paul&quot;)
articles.all(:published_at.gt =&gt; 2.weeks.ago)
articles.map { |a| a.title }
# =&gt; results in this query:
# Article.all( :author =&gt; &quot;Paul&quot;,
#              :published_at.gt =&gt; 2.weeks.ago )</code></pre>

</div>

<div class="slide">
<h1 id='strategiceager_loading'>Strategic-Eager Loading</h1>

<p>When getting associated models from an object in a collection, get the associated models for all objects in that collection.</p>

<pre><code>articles.each { |a| a.comments }`
# =&gt; results in this query:
# Comment.all( :article =&gt; articles )</code></pre>

</div>

<div class="slide">
<h1 id='plugins'>Plugins</h1>

<ul>
<li>types - yaml, json, xml, regexp, uuid, csv, ip_address, uri</li>

<li>migrations</li>

<li>validations - flexible, extensible</li>

<li>timestamps - created_at, etc</li>

<li>sweatshop - fixtures</li>

<li>is-list, is-nested_set, is-tree, is-state_machine</li>

<li>is-searchable</li>

<li>is-versioned</li>

<li>ar-finders</li>
</ul>

</div>

<div class="slide">
<h1 id='adapters'>Adapters</h1>

<p>Powerful adapter plugins mean its not just for RDBMSs:</p>

<ul>
<li>Heap</li>

<li><strong>Yaml files</strong></li>

<li>ReSTful web services</li>

<li>CouchDB</li>

<li>High-speed key-value stores (TokyoCabinet)</li>

<li>Salesforce, LDAP, Netflix, Google Video, &#8230;</li>
</ul>

</div>

<div class="slide">
<h1 id='what_makes_up_an_adapter'>What Makes Up an Adapter?</h1>

<p>Just a few simple methods:</p>

<ul>
<li><code>initialize(name, uri_or_options)</code></li>

<li><code>create(resources)</code></li>

<li><code>read(query)</code></li>

<li><code>update(attributes, query)</code></li>

<li><code>delete(query)</code></li>
</ul>

<p><em>Only applicable to datamapper/next</em></p>

</div>

<div class="slide">
<h1 id='initialize'>Initialize</h1>

<pre><code>def initialize(name, uri_or_options)
  super   # Turns uri_or_options into @options

  @path = FileUtils.mkdir_p(@options[:path])
end</code></pre>

</div>

<div class="slide">
<h1 id='createresources'>Create(resources)</h1>

<pre><code>def create(resources)
  resources.each do |resource|                    # 1
    set_next_key(resource)                        # 2
    update_records(resource.model) do |records|   # 3
      records[resource.key] = resource.attributes # 4
    end
  end

  resources.size                                  # 5
end</code></pre>

<ol class='handout'>
<li>resources is a collection of DM::Resource objects</li>

<li>we need to set the key on any Serial properties</li>

<li><code>#update_records</code> is a helper in yaml adapter that reads all records from the file for a model, yields it to the block, then writes the result back to the file.</li>

<li>Add the attributes (a Hash) for this resource to the records hash.</li>

<li>Return the number of created records. In this case, all of them.</li>
</ol>

</div>

<div class="slide">
<h1 id='readquery'>Read(query)</h1>

<pre><code>def read(query)
  records = records_for(query.model)     # 1
  filter_records(records.values, query)  # 2
end</code></pre>

<ol class='handout'>
<li><code>#records_for</code> reads all the records from the yaml file for this model. The records in this case is a Hash of <code>{ key =&gt; attrs }</code> pairs, with <code>key</code> being the array of keys for a record, and attrs being a hash of <code>{property_name =&gt; value}</code> pairs of attributes.</li>

<li><code>#filter_records</code> is where all the magic happens. If your data source doesn&#8217;t have any native searching or sorting capabilities, just run your records as an array of attribute hashes though this, and it will destructively remove all the records that don&#8217;t match the query. It will also sort and limit, as needed.</li>
</ol>

</div>

<div class="slide">
<h1 id='updateattributes_query'>Update(attributes, query)</h1>

<pre><code>  def update(attributes, query)
    # Translate the attributes from { Property =&gt; val }
    # to { :name =&gt; val }
    attributes = attributes.map do |p,v|
                   [ p.name, v ] 
                 end.to_hash

    update_records(query.model) do |records|
      updated = filter_records(records.values, query)
      updated.each { |r| r.update(attributes) }      # 1
      updated.size                                   # 2
    end
  end</code></pre>

<ol class='handout'>
<li>Update the the records that match the query with the new attributes.</li>

<li>Return the number of records that were updated.</li>
</ol>

</div>

<div class="slide">
<h1 id='deletequery'>Delete(query)</h1>

<pre><code>  def delete(query)
    update_records(query.model) do |records|
      deleted = filter_records(records.values, query).to_set
      records.delete_if { |_k,r| deleted.include?(r) } # 1
      deleted.size
    end
  end</code></pre>

<ol class='handout'>
<li>Delete the records that match the query.</li>
</ol>

</div>

<div class="slide">
<h1 id='how_do_i_know_my_adapter_works'>How do I Know My Adapter Works?</h1>

<pre><code>describe &#39;DataMapper::Adapters::YamlAdapter&#39; do
  before :all do
    @model = Heffalump
    @string_property  = @model.color
    @integer_property = @model.num_spots
  end

  it_should_behave_like &#39;An Adapter&#39;
end</code></pre>

</div>

<div class="slide">
<h1 id='advanced_topics'>Advanced Topics</h1>

<ul>
<li>
<p>Query</p>

<ul>
<li>Fields</li>

<li>Conditions</li>

<li>Order</li>

<li>Limit &amp; Offset</li>
</ul>
</li>
</ul>

</div>

<div class="slide">
<h1 id='query__fields'>Query - Fields</h1>

<pre><code>@fields=[
  #&lt;DataMapper::Property @model=Heffalump @name=:id&gt;, 
  #&lt;DataMapper::Property @model=Heffalump @name=:color&gt;, 
  #&lt;DataMapper::Property @model=Heffalump @name=:num_spots&gt;, 
  #&lt;DataMapper::Property @model=Heffalump @name=:striped&gt;
]</code></pre>

</div>

<div class="slide">
<h1 id='query__conditions'>Query - Conditions</h1>

<pre><code>@conditions=
  #&lt;DataMapper::Conditions::AndOperation
    @operands=[
      #&lt;DataMapper::Conditions::EqualToComparison
        @property=#&lt;DataMapper::Property 
                    @model=Heffalump 
                    @name=:id&gt;, 
        @value=4
      &gt;
    ]
  &gt;</code></pre>

</div>

<div class="slide">
<h1 id='query__order'>Query - Order</h1>

<pre><code>@order=[
  #&lt;DataMapper::Query::Direction:0xb792e804 
    @direction=:asc, 
    @property=#&lt;DataMapper::Property 
                @model=Heffalump 
                @name=:id&gt;
  &gt;
]</code></pre>

</div>

<div class="slide">
<h1 id='query__limit__offset'>Query - Limit &amp; Offset</h1>

<pre><code>@limit=20 
@offset=40</code></pre>

</div>

<div class="slide">
<h1 id='the_end'>The End</h1>

<p>~ fin ~</p></div>


</div>


</body>
</html>
